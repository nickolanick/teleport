---
title: Enhanced Session Recording for SSH with BPF
description: How to record your SSH session commands using BPF.
h1: Enhanced Session Recording with BPF
videoBanner: 8uO5H-iYw5A
---

This guide explains Enhanced Session Recording for SSH with BPF and how to set
it up in your Teleport cluster.

## Prerequisites

<Tabs>
<TabItem scope={["oss"]} label="Self-Hosted">

- A running Teleport cluster, version >= 7.0.0. For details on how to set this up,
  see [Getting Started on a Linux
  Server](../../getting-started/linux-server.mdx).

- The `tctl` admin tool version >= (=teleport.version=).

  ```code
  $ tctl version
  # Teleport v(=teleport.version=) go(=teleport.golang=)
  ```

  See [Installation](../../installation.mdx) for details.

- A Teleport Node running on a host with Linux kernel 5.8 (or above).

  You can check your kernel version using the `uname` command. The output should look
  something like the following.

  ```code
  $ uname -r
  # 5.8.17
  ```

  See below for more details on the required versions for your Linux kernel and
  distribution.

</TabItem>
<TabItem
  scope={["enterprise"]} label="Enterprise">

- A running Teleport cluster, version >= 7.0.0. For details on setting this up, see
  our [Enterprise getting started guide](../../enterprise/getting-started.mdx).

- The `tctl` admin tool version >= (=teleport.version=), which you can download
  by visiting the
  [customer portal](https://dashboard.gravitational.com/web/login).

  ```code
  $ tctl version
  # Teleport v(=teleport.version=) go(=teleport.golang=)
  ```

- A Teleport Node running on a host with Linux kernel 5.8 (or above).

  You can check your kernel version using the `uname` command. The output should look
  something like the following.

  ```code
  $ uname -r
  # 5.8.17
  ```

  See below for more details on the required versions for your Linux kernel and
  distribution.

</TabItem>
<TabItem scope={["cloud"]}
  label="Cloud">

- A Teleport Cloud account. If you do not have one, visit the
  [sign up page](https://goteleport.com/signup/) to begin your free trial.

- The Enterprise version of the `tctl` admin tool. To download this, visit
the [customer portal](https://dashboard.gravitational.com/web/login).

  ```code
  $ tctl version
  # Teleport v(=teleport.version=) go(=teleport.golang=)
  ```

- A Teleport Node running on a host with Linux kernel 5.8 (or above).

  You can check your kernel version using the `uname` command. The output should look
  something like the following.

  ```code
  $ uname -r
  # 5.8.17
  ```

  See below for more details on the required versions for your Linux kernel and
  distribution.

</TabItem>
</Tabs>

<Notice type="tip">

  Our Standard Session Recording works with older Linux Kernels. View
  [Teleport Nodes](../../architecture/nodes.mdx#session-recording) for more
  details.

</Notice>

### Linux distributions and supported kernels

<table>
<thead>
  <tr><td>Distro name</td><td>Distro version</td><td>Kernel version</td></tr>
</thead>
<tbody>
  <tr><td>Ubuntu "Groovy Gorilla"</td><td>20.10</td><td>5.8+</td></tr>
  <tr><td>Fedora</td><td>33</td><td>5.8+</td></tr>
  <tr><td>Archlinux</td><td>2020.09.01</td><td>5.8.5+</td></tr>
  <tr><td>Flatcar</td><td>2765.2.2</td><td>5.10.25+</td></tr>
</tbody>
</table>

(!docs/pages/includes/tctl.mdx!)

## Background

Teleport Nodes submit SSH session traffic to the Auth Service for
storage, copying what is echoed in a terminal. These recorded sessions can be
replayed later via the `tsh play` command or in the Teleport Web UI.

The advantage of this approach is that, since no input is captured, these
session recordings do not contain passwords that were entered into a terminal.

The disadvantage is that session recordings can be bypassed using several
techniques:

- **Obfuscation**. For example, even though the command
  `echo Y3VybCBodHRwOi8vd3d3LmV4YW1wbGUuY29tCg== | base64 --decode | sh` does not contain
  `curl http://www.example.com`, when decoded, that is what is run.
- **Shell scripts**. For example, if a user uploads and executes a script, the
  commands run within the script are not captured, simply the output.
- **Terminal controls**. Terminals support a wide variety of controls including
  the ability for users to disable terminal echo. This is frequently used when
  requesting credentials. Disabling terminal echo allows commands to be run
  without being captured.

Furthermore, due to their unstructured nature, session recordings are difficult to
ingest and perform monitoring and alerting on.

Teleport Enhanced Session Recording mitigates all three concerns by providing
advanced security, greater logging capabilities, and better correlates a user
with their activities.

## Step 1/2. Install and configure a Teleport Node

Set up your Teleport Node with the following content in `etc/teleport.yaml`. 

```yaml
# Example config to be saved as etc/teleport.yaml
teleport:
  nodename: graviton-node
  auth_token: exampletoken
  auth_servers:
  # Replace with the address of the Teleport Auth Server.
  - 127.0.0.1:3025
  data_dir: /var/lib/teleport
proxy_service:
  enabled: false
auth_service:
  enabled: false
ssh_service:
  enabled: true
  enhanced_recording:
    # Enable or disable enhanced auditing for this node. Default value: false.
    enabled: true

    # Optional: command_buffer_size is optional with a default value of 8 pages.
    command_buffer_size: 8

    # Optional: disk_buffer_size is optional with default value of 128 pages.
    disk_buffer_size: 128

    # Optional: network_buffer_size is optional with default value of 8 pages.
    network_buffer_size: 8

    # Optional: Controls where cgroupv2 hierarchy is mounted. Default value:
    # /cgroup2.
    cgroup_path: /cgroup2
```

## Step 2/2. Inspect the audit log

<Tabs>
<TabItem scope={["oss", "enterprise"]} label="Self-Hosted">

Enhanced session recording events will be shown in Teleport's audit log, which
you can inspect by visiting Teleport's Web UI.

Sessions with Enhanced Session Recording will include the
`"enhanced_recording": true` field in events similar to the following:

```json
{
  "code": "T2004I",
  "ei": 23,
  "enhanced_recording": true,
  "event": "session.end",
  "interactive": true,
  "namespace": "default",
  "participants": [
    "benarent"
  ],
  "server_id": "585fc225-5cf9-4e9f-8ff6-1b0fd6885b09",
  "sid": "ca82b98d-1d30-11ea-8244-cafde5327a6c",
  "time": "2019-12-12T22:44:46.218Z",
  "uid": "83e67464-a93a-4c7c-8ce6-5a3d8802c3b2",
  "user": "benarent"
}
```

If you would like to examine your audit log on the Teleport Auth Service host,
you can examine the contents of `/var/lib/teleport/log` as shown below:

```code
$ teleport-auth ~:  tree /var/lib/teleport/log
# /var/lib/teleport/log
# ├── 1048a649-8f3f-4431-9529-0c53339b65a5
# │   ├── 2020-01-13.00:00:00.log
# │   └── sessions
# │       └── default
# │           ├── fad07202-35bb-11ea-83aa-125400432324-0.chunks.gz
# │           ├── fad07202-35bb-11ea-83aa-125400432324-0.events.gz
# │           ├── fad07202-35bb-11ea-83aa-125400432324-0.session.command-events.gz
# │           ├── fad07202-35bb-11ea-83aa-125400432324-0.session.network-events.gz
# │           └── fad07202-35bb-11ea-83aa-125400432324.index
# ├── events.log -> /var/lib/teleport/log/1048a649-8f3f-4431-9529-0c53339b65a5/2020-01-13.00:00:00.log
# ├── playbacks
# │   └── sessions
# │       └── default
# └── upload
#    └── sessions
#        └── default
```

To quickly check the status of the audit log, you can simply tail the logs with
`tail -f /var/lib/teleport/log/events.log`. The resulting capture from Teleport will
be a JSON log for each command and network request.
</TabItem>
<TabItem scope={["cloud"]} label="Teleport Cloud">

Enhanced session recording events will be shown in Teleport's audit log, which
you can inspect by visiting Teleport's Web UI.

Sessions with Enhanced Session Recording will include the
`"enhanced_recording": true` field in events similar to the following:

```json
{
  "code": "T2004I",
  "ei": 23,
  "enhanced_recording": true,
  "event": "session.end",
  "interactive": true,
  "namespace": "default",
  "participants": [
    "benarent"
  ],
  "server_id": "585fc225-5cf9-4e9f-8ff6-1b0fd6885b09",
  "sid": "ca82b98d-1d30-11ea-8244-cafde5327a6c",
  "time": "2019-12-12T22:44:46.218Z",
  "uid": "83e67464-a93a-4c7c-8ce6-5a3d8802c3b2",
  "user": "benarent"
}
```
</TabItem>
</Tabs>

## Next steps

- Read more about
  [session recording](../../architecture/nodes.mdx#session-recording).
- See all configuration options for Enhanced Session Recording in our
  [Configuration Reference](../../setup/reference/config.mdx).